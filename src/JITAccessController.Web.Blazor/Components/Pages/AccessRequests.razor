@page "/access-requests"
@using JITAccessController.Web.Blazor.Kubernetes
@using JITAccessController.Web.Blazor.Components.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using k8s
@using k8s.Autorest
@using k8s.KubeConfigModels
@using k8s.Models
@rendermode InteractiveServer
@attribute [Authorize]
@inherits JITAccessController.Web.Blazor.Components.Shared.AccessRequestPageBase
@inject IKubernetes K8sClient
@inject AccessRequestStore RequestStore
@inject AccessPolicyStore PolicyStore
@inject ClusterAccessRequestStore ClusterRequestStore
@inject ClusterAccessPolicyStore ClusterPolicyStore
@inject IKubernetes K8sClient

<PageTitle>Access Requests</PageTitle>

@if (!string.IsNullOrWhiteSpace(Error)) {
    <div>@Error</div>
}

<div class="row">
    <div class="col-md-6">
        <div class="card mb-2 mb-md-0">
            <div class="card-header">
                My Access Requests
            </div>
            <div class="card-body">
                @if (myRequests != null && myRequests.Count() > 0) {
                    <AccessRequestList AccessRequests="@myRequests" CanApproveRequest="@(request => false)" OnRefreshRequested="Refresh" OnError="ShowError" />
                }
                else {
                    <p class="card-text">No access requests were found</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                Pending Approval
            </div>
            <div class="card-body">
                @if (pendingRequests != null && pendingRequests.Count() > 0) {
                    <AccessRequestList AccessRequests="@pendingRequests" CanApproveRequest="@(request => !request.AlreadyApprovedByUser(GetUsername()))" OnRefreshRequested="Refresh" OnError="ShowError" />
                }
                else {
                    <p class="card-text">No access requests pending approval</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    public string Error = "";

    private List<ClusterAccessRequest> clusterAccessRequests = new List<ClusterAccessRequest>();
    private List<ClusterAccessPolicy> clusterAccessPolicies = new List<ClusterAccessPolicy>();
    private List<AccessRequest> accessRequests = new List<AccessRequest>();
    private List<AccessPolicy> accessPolicies = new List<AccessPolicy>();

    private IEnumerable<BaseAccessRequest> myRequests => 
        clusterAccessRequests
            .Where(r => IsMyRequest(r))
            .Cast<BaseAccessRequest>()
            .Concat(
                accessRequests
                    .Where(r => IsMyRequest(r))
                    .Cast<BaseAccessRequest>()
            ).OrderByDescending(r => r.Metadata.CreationTimestamp);
    
    private IEnumerable<BaseAccessRequest> pendingRequests =>
        clusterAccessRequests
            .Where(r => r.Status?.State == "Pending" && !IsMyRequest(r) && ICanApprove(r, clusterAccessPolicies))
            .Cast<BaseAccessRequest>()
            .Concat(
                accessRequests
                    .Where(r => r.Status?.State == "Pending" && !IsMyRequest(r) && ICanApprove(r, accessPolicies))
                    .Cast<BaseAccessRequest>()
            ).OrderByDescending(r => r.Metadata.CreationTimestamp);

    // Authentication helpers provided by AccessRequestPageBase

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        ClusterRequestStore.OnChanged += Refresh;
        ClusterPolicyStore.OnChanged += Refresh;

        RequestStore.OnChanged += Refresh;
        PolicyStore.OnChanged += Refresh;

        Refresh();
    }

    private void ShowError(Exception ex) {
        Error = ex.Message;
        
        InvokeAsync(StateHasChanged);
    }

    private bool IsMyRequest(BaseAccessRequest request)
    {
        if (authState == null || !IsAuthenticated())
            return false;

        var username = authState.User.Claims.FirstOrDefault(c => c.Type == "preferred_username");

        if (username == null)
        {
            return false;
        }

        if (request.Spec?.Subject == username.Value)
        {
            return true;
        }

        return false;
    }

    private bool ICanApprove(BaseAccessRequest request, IEnumerable<BaseAccessPolicy> policies)
    {
        if (authState == null || !IsAuthenticated())
            return false;

        var username = authState.User.Claims.FirstOrDefault(c => c.Type == "preferred_username");
        var groups = authState.User.Claims.Where(c => c.Type == "groups").Select(c => c.Value);

        return request.CanApprove(username?.Value ?? "", groups, policies);
    }

    private void Refresh()
    {
        if(authState == null || !IsAuthenticated())
            return;

        var username = authState.User.Claims.FirstOrDefault(c => c.Type == "preferred_username");
        
        if(username == null) {
            return;
        }

        clusterAccessPolicies = ClusterPolicyStore.All.ToList();
        clusterAccessRequests = ClusterRequestStore.All
            .Where(r => IsMyRequest(r) || ICanApprove(r, clusterAccessPolicies))
            .ToList();

        accessPolicies = PolicyStore.All.ToList();
        accessRequests = RequestStore.All
            .Where(r => IsMyRequest(r) || ICanApprove(r, accessPolicies))
            .ToList();
        
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ClusterRequestStore.OnChanged -= Refresh;
        ClusterPolicyStore.OnChanged -= Refresh;
        RequestStore.OnChanged -= Refresh;
        PolicyStore.OnChanged -= Refresh;
    }
}
